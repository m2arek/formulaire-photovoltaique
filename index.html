function saveAsPDF() {
    const { jsPDF } = window.jspdf;

    // Forcer la taille correcte de la carte avant la capture
    map.invalidateSize();

    // Appliquer un décalage manuel sur les dessins avant la capture
    const mapContainer = document.getElementById('map');
    const leafletDrawLayer = mapContainer.querySelector('.leaflet-draw-layer');

    if (leafletDrawLayer) {
        leafletDrawLayer.style.transform = 'translate(20%, 20%)'; // Décalage de 20% à droite et en bas
    }

    // Capturer la carte et les dessins avec html2canvas
    html2canvas(mapContainer, {
        useCORS: true, // Permet de capturer les tuiles Leaflet
        allowTaint: true, // Permet de traiter des éléments provenant de sources externes
        scale: 2, // Améliore la qualité
        logging: false,
    }).then((canvas) => {
        const doc = new jsPDF();

        const address = document.getElementById('address').value;
        const consumption = document.getElementById('consumption').value;

        doc.text("Formulaire d'installation photovoltaïque", 10, 10);
        doc.text(`Adresse : ${address}`, 10, 20);
        doc.text(`Consommation en kWh : ${consumption}`, 10, 30);

        // Ajouter la capture d'écran de la carte au PDF
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 190; // Largeur d'image dans le PDF
        const imgHeight = (canvas.height * imgWidth) / canvas.width; // Respecter les proportions
        doc.addImage(imgData, 'PNG', 10, 50, imgWidth, imgHeight);

        // Supprimer le décalage des dessins après la capture
        if (leafletDrawLayer) {
            leafletDrawLayer.style.transform = ''; // Réinitialiser le décalage
        }

        doc.save("formulaire_photovoltaique.pdf");
    });
}
